<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitit</title>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .cursive {
            font-family: 'Pacifico', cursive;
        }
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        .title-bar {
            /* background-color: #800020; */
            /* color: #D3D3D3; */
            color:#800020;
            text-align: center;
            padding: 15px 15px;
            font-size: 24px;
            font-weight: bold;
            border-bottom:1px solid #b7b7b7; ;
        }
        .content {
            padding: 0px 20px;
        }
        .flat-button {
            background: linear-gradient(135deg, #a445b2, #d41872, #06bcff);
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 24px;
            border-radius: 30px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            width:100%;
        }
        .flat-button-sub {
            background:  #06bcff;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            border-radius: 30px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            width:100%;
        }
        .subControlButton{
            background:  #ffffff;
            border: 1px solid;
            border-color: #646464;
            color: #646464;
            font-size: 24px;
            cursor: pointer;
            width: 45%;
            border-radius: 10px;
        }
        main {
            padding: 1em;
        }
        section {
            margin-bottom: 2em;
            
        }
         .gender {
            display: flex;
            gap: 1em;
            background-color: #ebebeb;
            border-radius: 50px;
        }

        .styles, .styles_M, .backgrounds {
            display: flex;
            gap: 1em;
            flex-wrap: wrap;
          
        }
        .styles div, .styles_M div, .backgrounds div{
            flex: 1 1 calc(50% - 10px); /* Two items per row with some space between */
            box-sizing: border-box;
            padding: 10px;
            /* border: 1px solid #ccc;  */
            text-align: center;
        }
        .gender div {
            /* border: 1px solid #800020; */
            
            padding: 1em;
            cursor: pointer;
            flex: 1;
            text-align: center;
            border-radius: 50px;

        }
        .styles img, .styles_M img{
            width:100%;
            height: 80%;
            object-fit: cover; /* Ensure the image covers the container */
            aspect-ratio: 1.2; /* Make the image a square */
            border-radius: 10px;
        }
        .backgrounds img{
            width:100%;
            height: 80%;
            object-fit: cover; /* Ensure the image covers the container */
            aspect-ratio: 1.2; /* Make the image a square */
            border-radius: 10px;
        }
        #clothing-style-man {
            display: none;
        }


     
        /* .styles div:hover, .backgrounds div:hover, .gender div:hover{
            background-color: #ff7272;
        } */
        .selected {
            color: #212121;
            /* border-color: #212121; */
            background-color: #c9c9c9;
            border-radius: 10px;
        }
         /* 로딩 스크린 스타일 */
         #loading {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 로딩 스피너 스타일 */
        .spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            position: absolute;
        }
        #againButton{
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .resultImage{
           width: 100%;
           border-radius: 10px;
        }
        .button-container {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        .resultImageContainer{
            display: none;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .resultImageSet{
            width: 45%;
            text-align: center;
            
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
    </div>
    <div id="content" style="display:none;">
        <div class="title-bar cursive">
            Fit it
        </div>
       
        <div class="content" id="gender_select">
            <main>
                <section id="sel_gender">
                    <h2> Gender</h2>
                    <div class="gender">
                        <div id="gender_0" class="selected">Female</div>
                        <div id="gender_1">Male</div>
                    </div>
                </section>
            </main>
        </div>
        <div class="content" id="condition_select">
            <main>
                <section id="clothing-style">
                    <h2> Style</h2>
                    <div class="styles">
                        <div id="style_0" class="selected"><img src="static/dress/female/Oversized Blazer and Crop Top Combo.png" alt="Female Image" />Oversized Blazer and Crop Top Combo</div>
                        <div id="style_1"><img src="static/dress/female/Pleated Skirt and Sneakers.png" alt="Female Image" />Pleated Skirt and Sneakers</div>
                        <div id="style_2"><img src="static/dress/female/WhiteBlouseDenimShorts.png" alt="Female Image" />White Blouse + Denim Shorts</div>
                        <div id="style_3"><img src="static/dress/female/Floral Print Dress + Sandals.png" alt="Female Image" />Floral Print Dress + Sandals</div>
                        <div id="style_4"><img src="static/dress/female/Graphic T-Shirt + Mini Skirt.png" alt="Female Image" />Graphic T-Shirt + Mini Skirt</div>
                        <div id="style_5"><img src="static/dress/female/Slip Dress + Denim Jacket.png" alt="Female Image" />Slip Dress + Denim Jacket</div>
                        <div id="style_6"><img src="static/dress/female/Sleeveless Knit Top + Wide-Leg Pants.png" alt="Female Image" />Sleeveless Knit Top + Wide-Leg Pants</div>
                        <div id="style_7"><img src="static/dress/female/Blouse + High-Waisted Shorts.png" alt="Female Image" />Blouse + High-Waisted Shorts</div>
                    </div>
                </section>
                <section id="clothing-style-man">
                    <h2> Style</h2>
                    <div class="styles_M">
                        <div id="style_0" class="selected"><img src="static/dress/male/Linen Shirt + Chino Shorts.png" alt="Male Image" />Linen Shirt + Chino Shorts</div>
                        <div id="style_1"><img src="static/dress/male/Polo Shirt + Slim-Fit Chino Pants.png" alt="Male Image" />Polo Shirt + Slim-Fit Chino Pants</div>
                        <div id="style_2"><img src="static/dress/male/Short-Sleeve Button-Down Shirt + Denim Shorts.png" alt="Male Image" />Short-Sleeve Button-Down Shirt + Denim Shorts</div>
                        <div id="style_3"><img src="static/dress/male/White T-Shirt + Denim Shorts.png" alt="Male Image" />White T-Shirt + Denim Shorts</div>
                    </div>
                </section>
                <section id="background">
                    <h2> Background</h2>
                    <div class="backgrounds">
                        <div id="bg_0" class="selected"><img src="static/bg/Luxurious mansion staircase.png" alt="Background Image" />Luxurious mansion staircase</div>
                        <div id="bg_1"><img src="static/bg/Modern urban rooftop.png" alt="Background Image" />Modern urban rooftop</div>
                        <div id="bg_2"><img src="static/bg/Tropical jungle.png" alt="Background Image" />Tropical jungle</div>
                        <div id="bg_3"><img src="static/bg/Industrial warehouse.png" alt="Background Image" />Industrial warehouse</div>
                        <div id="bg_4"><img src="static/bg/Minimalist white studio.png" alt="Background Image" />Minimalist white studio</div>
                        <div id="bg_5"><img src="static/bg/Beachside resort.png" alt="Background Image" />Beachside resort</div>
                        <div id="bg_6"><img src="static/bg/Classic European street.png" alt="Background Image" />Classic European street</div>
                        <div id="bg_7"><img src="static/bg/Picturesque vineyard.png" alt="Background Image" />Picturesque vineyard</div>
                        <div id="bg_8"><img src="static/bg/Autumn forest.png" alt="Background Image" />Autumn forest</div>
                        <div id="bg_9"><img src="static/bg/Chic modern living room.png" alt="Background Image" />Chic modern living room</div>
                    </div>
                </section>
            </main>
        </div>
        <div class="content" id="upload">
            <input style="display: none;" type="file" id="fileInput" />
            <br><br>
            <button class="flat-button cursive" id="uploadButton">Fit it</button>
            <br><br>
            <button class="flat-button-sub" id="againButton">Again same picture</button>
            <br><br><br>
            
            <div id="imagesContainer">
                <div class="resultImageContainer">
                    <div class="resultImageSet">
                        <img id="resultImage1" class="resultImage" src="static/result_2024-06-22 22-08-50_B.jpg" />
                        <div class="button-container">
                            <button class="subControlButton" id="likeA"><i class="fas fa-thumbs-up"></i></button>
                            <button class="subControlButton" id="downloadA"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    <div class="resultImageSet">
                        <img id="resultImage2" class="resultImage" src="static/result_2024-06-22 22-08-50_B.jpg"/>
                        <div class="button-container">
                            <button class="subControlButton" id="likeB"><i class="fas fa-thumbs-up"></i></button>
                            <button class="subControlButton" id="downloadB"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    </div>
    <script type="module">
        let uploadUrl = 'http://kjhbest.iptime.org:8080'
        
        let global_taskid;
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCwJodY83c12cRzGAs4QXr4P7dmphHwRTU",
          authDomain: "fit-it-analytics.firebaseapp.com",
          projectId: "fit-it-analytics",
          storageBucket: "fit-it-analytics.appspot.com",
          messagingSenderId: "403285719660",
          appId: "1:403285719660:web:23105be5ae490067847649",
          measurementId: "G-9Z1M2D08YJ"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        
        // 페이지가 완전히 로드되면 로딩 스크린을 숨기고 콘텐츠를 보여줍니다.
        window.addEventListener('load', function() {
            var loadingScreen = document.getElementById('loading');
            var content = document.getElementById('content');
            loadingScreen.style.display = 'none';
            content.style.display = 'block';
        });
        
        document.getElementById('sel_gender').addEventListener('click', function(){
            const selectedOptions = document.querySelectorAll('.selected');
            var styles = document.querySelector("#clothing-style");
            var stylesM = document.querySelector("#clothing-style-man");
            if(selectedOptions[0].id == "gender_0"){
                console.log("0")
                styles.style.display = "block"
                stylesM.style.display = "none"
            }else{
                console.log("2")
                styles.style.display = "none"
                stylesM.style.display = "block"
            }
            const styleOptions = document.querySelectorAll('.styles div');
            styleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    styleOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        });
        document.addEventListener('DOMContentLoaded', () => {
            console.log("RunSelect")
            const genderOptions = document.querySelectorAll('.gender div');
            const styleOptions = document.querySelectorAll('.styles div');
            const styleMOptions = document.querySelectorAll('.styles_M div');
            const backgroundOptions = document.querySelectorAll('.backgrounds div');
            
            genderOptions.forEach(option => {
                option.addEventListener('click', () => {
                    genderOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });

            styleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    styleOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });

            styleMOptions.forEach(option => {
                option.addEventListener('click', () => {
                    styleMOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });

            backgroundOptions.forEach(option => {
                option.addEventListener('click', () => {
                    backgroundOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        });
        //  다시 업로드(같은 사진)
        document.getElementById('againButton').addEventListener('click', function() {
            const selectedOptions = document.querySelectorAll('.selected');
            let selStyle = selectedOptions[0].id == "gender_0"?1:2
            const selDatas = {
                "gender" : selectedOptions[0].id.replace("gender_",''),
                "style"  : selectedOptions[selStyle].id.replace("style_",''),
                "bg"     : selectedOptions[3].id.replace("bg_",''),
                }
            logEvent(analytics, 'select_list',{
                gender:selectedOptions[0].id.replace("gender_",''),
                style:selectedOptions[selStyle].id.replace("style_",''),
                bg:selectedOptions[3].id.replace("bg_",'')
            });
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
                
                if (!file) {
                    alert('파일을 선택해주세요.');
                    return;
                }
                // 로딩 바 보이기
                var loadingScreen = document.getElementById('loading');
                var content = document.getElementById('content');
                loadingScreen.style.display = 'flex';
                content.style.display = 'flex';

                const formData = new FormData();
                formData.append('file', file);
                formData.append('datas', JSON.stringify(selDatas));
                
                fetch(uploadUrl+'/upload', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    console.log('성공:', data);
                    if(data.images != undefined){
                        displayImages(data.images);
                        var loadingScreen = document.getElementById('loading');
                        var content = document.getElementById('content');
                        loadingScreen.style.display = 'none';
                        content.style.display = 'block';
                        const againButton = document.getElementById('againButton');
                        againButton.style.display = "block"
                        window.scroll({
                            top: document.body.scrollHeight,
                            behavior: 'smooth'
                            });
                    }
                })
                .catch((error) => {
                    console.error('오류:', error);
                    var loadingScreen = document.getElementById('loading');
                    var content = document.getElementById('content');
                    loadingScreen.style.display = 'none';
                    content.style.display = 'block';
                    
                });

        });
        // 파일 업로드
        document.getElementById('uploadButton').addEventListener('click', function() {
            const selectedOptions = document.querySelectorAll('.selected');
            let selStyle = selectedOptions[0].id == "gender_0"?1:2
            const selDatas = {
                "gender" : selectedOptions[0].id.replace("gender_",''),
                "style"  : selectedOptions[selStyle].id.replace("style_",''),
                "bg"     : selectedOptions[3].id.replace("bg_",''),
                }
            logEvent(analytics, 'select_list',{
                gender:selectedOptions[0].id.replace("gender_",''),
                style:selectedOptions[selStyle].id.replace("style_",''),
                bg:selectedOptions[3].id.replace("bg_",'')
            });
            const fileInput = document.getElementById('fileInput');
            fileInput.value='';
            // 파일 선택 대화상자 열기
            fileInput.click();
            
            // 파일이 선택되면 업로드 시작
            fileInput.onchange = function() {
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('파일을 선택해주세요.');
                    return;
                }
                // 로딩 바 보이기
                var loadingScreen = document.getElementById('loading');
                var content = document.getElementById('content');
                loadingScreen.style.display = 'flex';
                content.style.display = 'flex';
                
                var imagecontainer = document.querySelector(".resultImageContainer");
                imagecontainer.style.display="flex";
                

                const formData = new FormData();
                formData.append('file', file);
                formData.append('datas', JSON.stringify(selDatas));
                
                fetch(uploadUrl+'/upload', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    console.log('성공:', data);
                    if(data.images != undefined){
                        displayImages(data.images);
                        var loadingScreen = document.getElementById('loading');
                        var content = document.getElementById('content');
                        loadingScreen.style.display = 'none';
                        content.style.display = 'block';
                        const againButton = document.getElementById('againButton');
                        againButton.style.display = "block"
                        window.scroll({
                            top: document.body.scrollHeight,
                            behavior: 'smooth'
                            });
                    }
                })
                .catch((error) => {
                    console.error('오류:', error);
                    var loadingScreen = document.getElementById('loading');
                    var content = document.getElementById('content');
                    loadingScreen.style.display = 'none';
                    content.style.display = 'block';
                    
                });
            }
        });
       
     
        function displayImages(images) {
            var likebtnA = document.getElementById('likeA');
            likebtnA.style.color= "#646464";
            var likebtnB = document.getElementById('likeB');
            likebtnB.style.color= "#646464";
            const imagesContainer = document.getElementById('imagesContainer');
            
            var i=1;
            images.forEach(imgStr => {
                var srcid = 'resultImage'+i
                const img =  document.getElementById(srcid);
                console.log(srcid,img);
                img.src = `data:image/png;base64,${imgStr}`;
                
                i++;
            });
        }
        document.getElementById('likeA').addEventListener('click', function() {
            var likebtn = document.getElementById('likeA');
            likebtn.style.color= "#06bcff";
            logEvent(analytics, 'likeA_button_click');
        });
        document.getElementById('likeB').addEventListener('click', function() {
            var likebtn = document.getElementById('likeB');
            likebtn.style.color= "#06bcff";
            logEvent(analytics, 'likeB_button_click');
        });
        document.getElementById('downloadA').addEventListener('click', function() {
            var img = document.getElementById('resultImage1');
            var imageURL = img.src;
            logEvent(analytics, 'downloadA_button_click');
            // 링크 생성
            var link = document.createElement('a');
            link.href = imageURL;
            var timestamp = Date.now();

            // 파일 이름 생성 (예: image_1624032131000.jpg)
            var fileName = `image_${timestamp}.jpg`;
            link.download = fileName;

            // 링크 클릭 시뮬레이션
            document.body.appendChild(link);
            link.click();

            // 링크 삭제
            document.body.removeChild(link);
        
        });
        document.getElementById('downloadB').addEventListener('click', function() {
            var img = document.getElementById('resultImage2');
            var imageURL = img.src;
            logEvent(analytics, 'downloadB_button_click');
            // 링크 생성
            var link = document.createElement('a');
            link.href = imageURL;
            var timestamp = Date.now();

            // 파일 이름 생성 (예: image_1624032131000.jpg)
            var fileName = `image_${timestamp}.jpg`;
            link.download = fileName;

            // 링크 클릭 시뮬레이션
            document.body.appendChild(link);
            link.click();

            // 링크 삭제
            document.body.removeChild(link);
        
        });
        
    </script>
    
</body>
</html>
